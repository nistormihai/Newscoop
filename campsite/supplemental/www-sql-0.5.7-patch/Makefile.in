
# The version number
VER = @VERSION@

# Set the default username and password for www-sql to use
SQL_USER = nobody
SQL_PASS =

SQL_DEFS = -DSQL_USER=\"$(SQL_USER)\" -DSQL_PASS=\"$(SQL_PASS)\"

# Target is the db to use for the www-sql binary (currently mysql or pgsql)
TARGET = @TARGET@

# The directory to install the CGI program
CGI_DIR = @CGI_DIR@

# Locations of the various mysql components
MYSQLINC = @MYSQL_INCDIR@
MYSQLLIB = @MYSQL_LIBDIR@

# Locations of the various PostgreSQL components
PGSQLINC = @PGSQL_INCDIR@
PGSQLLIB = @PGSQL_LIBDIR@

# change these to suit your system
CC = @CC@
INSTALL = @INSTALL@
LEX = @LEX@
YACC = @YACC@

CFLAGS = @CFLAGS@
CPPFLAGS = -I@srcdir@ @REINC@ @DEFS@
LDFLAGS = -lm -lz @SOCK_LIB@ @LIBS@

DISTFILES = lib/COPYING.LIB lib/regex.c lib/regex.h \
 lib/xmalloc.c lib/xmalloc.diff lib/xstrdup.c COPYING Changelog \
 Makefile.in README acconfig.h aclocal.m4 cgi.c cgi.h cmds.c cmds.h \
 config.h.in configure configure.in example.pgsql example.sql func.c \
 if.c if.h install-sh mysql.c newexpr.c newexpr.y newscan.h newscan.c pgsql.c \
 scanner.c scanner.l www-sql.c www-sql.html www-sql.spec

# object files that are not database specific (ie not mysql.c, pgsql.c)
OBJS = cgi.o newexpr.o cmds.o func.o if.o @SCANNER@ www-sql.o \
 @EXTRA_OBJS@

all: www-sql

www-sql: www-$(TARGET)
	@[ -f www-sql ] && rm -f www-sql || true
	cp -f www-$(TARGET) www-sql

www-mysql: $(OBJS) mysql.o
	$(CC) $(OBJS) mysql.o -o $@ $(MYSQLLIB) -lmysqlclient $(LDFLAGS)
mysql.o: mysql.c cmds.h
	$(CC) $(CFLAGS) $(CPPFLAGS) $(SQL_DEFS) $(MYSQLINC) -c $< -o $@

www-pgsql: $(OBJS) pgsql.o
	$(CC) $(OBJS) pgsql.o -o $@ $(PGSQLLIB) -lpq @CRYPT_LIB@ $(LDFLAGS)
pgsql.o: pgsql.c cmds.h
	$(CC) $(CFLAGS) $(CPPFLAGS) $(SQL_DEFS) $(PGSQLINC) -c $< -o $@

cmds.o: cmds.c cmds.h cgi.h if.h
func.o: func.c cmds.h cgi.h
newscan.o: newscan.c newscan.h if.h

scanner.o: scanner.c if.h
scanner.c: scanner.l

www-sql.o: cgi.h if.h

.c.o:
	$(CC) $(CFLAGS) $(CPPFLAGS) -c $< -o $@

.l.c:
	$(LEX) $(LEXFLAGS) -t $< > $@

.y.c:
	$(YACC) $(YACCFLAGS) $<
	mv -f y.tab.c $@

# housekeeping routines
install: all
	$(INSTALL) -m 755 -s www-sql $(CGI_DIR)

clean:
	rm -rf *.o lib/*.o client core www-sql www-mysql www-pgsql Makefile

distclean: clean
	rm -f config.cache config.log config.status config.h

dist: www-sql-$(VER).tar.gz
www-sql-$(VER).tar.gz: $(DISTFILES)
	@echo Building distribution ...
	@if [ -f www-sql-$(VER) ]; then rm -f www-sql-$(VER); fi
	@ln -s . www-sql-$(VER)
	@tar czvf www-sql-$(VER).tar.gz $(addprefix www-sql-$(VER)/,$(DISTFILES))
	@rm -f www-sql-$(VER)

autoconf: configure config.h.in

Makefile config.h: Makefile.in config.h.in config.status
	$(SHELL) ./config.status
	@touch config.h
config.status: configure
	$(SHELL) ./config.status --recheck
configure: configure.in aclocal.m4
	autoconf
config.h.in: configure.in acconfig.h
	autoheader
	@touch config.h.in

.PHONY: all install clean distclean dist autoconf
